
svar_set sartris_version "0.0.3"
svar_set sartris_build "22/02/2022"
sar_function sartris_about "echo $'SARtris Classic v$sartris_version (Built $sartris_build)$'; echo $'Created and maintained by AMJ$'; echo $'More information (not yet) available at thisamj.github.io/sartris$'"
sartris_about

// Define tetrominoes
sar_expand exec $sartris_root/tetrominoes

sar_function sartris_clear_lines "svar_set __sartris_clear_i 19; repeat $'__sartris_clear_lines; svar_sub __sartris_clear_i 1$' 20"
sar_function __sartris_clear_lines "svar_set __sartris_clear_j 0; sartris_line_check; less_than 0 1; while $'!var:__sartris_line_check=$sartris_tex_empty & var:less_than_ret=1$' ___sartris_clear_lines; cond $'var:less_than_ret=0$' sartris_clear_line $__sartris_clear_i"
sar_function ___sartris_clear_lines "sartris_line_check; less_than $__sartris_clear_j 20; svar_add __sartris_clear_j 1"
sar_function sartris_line_check "sar_expand svar_set __sartris_line_check $'$$sartris_dbuf_$__sartris_clear_i$-_$__sartris_clear_j$'"
sar_function sartris_clear_line "_sartris_clear_line $1; svar_add __sartris_clear_i 1"
sar_function _sartris_clear_line "__sartris_line_drop $1; svar_set __tmp $1; svar_sub __tmp 1; cond $'!var:__tmp=0$' sar_expand _sartris_clear_line $$__tmp"

sar_function __sartris_line_drop    "svar_set __sartris_line_drop_i 0; repeat $'__sartris_line_drop_h $1; svar_add __sartris_line_drop_i 1$' 10"
sar_function __sartris_line_drop_h  "svar_set __tmp $1; svar_sub __tmp 1; sar_expand sar_expand sartris_dbuf_set  $__sartris_line_drop_i $1 $'$$$$sartris_dbuf_$$__tmp$$-_$__sartris_line_drop_i$'"
// sar_function __sartris_clear_line "___sartris_clear_line $1 0; ___sartris_clear_line $1 1; ___sartris_clear_line $1 2; ___sartris_clear_line $1 3; ___sartris_clear_line $1 4; ___sartris_clear_line $1 5; ___sartris_clear_line $1 6; ___sartris_clear_line $1 7; ___sartris_clear_line $1 8; ___sartris_clear_line $1 9"
// sar_function ___sartris_clear_line "svar_set __tmp $1; svar_sub __tmp 1; sar_expand sar_expand sartris_dbuf_set $1 $2 $'$$$$sartris_dbuf_$$__tmp$-_$2$'"
// sar_function sartris_set_top 

sar_function sartris_player_lock "sartris_player_collide_undraw 0 1 $sartris_player_rot; __choose $'var:sartris_player_collide_ret=1$' $'sartris_player_draw; sartris_clear_lines; sartris_player_new; sartris_player_draw$' $'$1$'"
sar_function sartris_player_gravity "sartris_player_lock $'sartris_player_move 0 1 $sartris_player_rot$'"
sar_function sartris_player_move "sartris_player_lock nop; sartris_player_collide_undraw $1 $2 $sartris_player_rot; cond $'var:sartris_player_collide_ret=0$' $'svar_add sartris_player_x $1; svar_add sartris_player_y $2$'; sartris_player_draw"
sar_function __sartris_player_move "sartris_player_undraw; svar_add sartris_player_x $1; svar_add sartris_player_y $2; sartris_player_draw"
sar_function sartris_player_rot "svar_set sartris_player_rotdesired $sartris_player_rot; svar_add sartris_player_rotdesired $1; svar_mod sartris_player_rotdesired 4; sar_expand sartris_player_collide_undraw 0 0 $$sartris_player_rotdesired; cond $'var:sartris_player_collide_ret=0$' $'sar_expand svar_set sartris_player_rot $$sartris_player_rotdesired$'; sartris_player_draw"

// sartris_player_collide <x_off> <y_off> <rot>
// Return var: sartris_player_collide_ret
sar_alias sartris_player_collide_undraw "sartris_player_undraw; sartris_player_collide"
sar_function sartris_player_collide "svar_set sartris_player_collide_ret 0; sartris_player_minocoord_foreach $'__sartris_player_collide $1 $2$' $3"
sar_function __sartris_player_collide "svar_add __tmp_x $1; svar_add __tmp_y $2; sar_expand less_than $$__tmp_x 0; sar_expand cond $'var:less_than_ret=1 | !var:sartris_dbuf_$$__tmp_y$$-_$$__tmp_x=$sartris_tex_empty$' svar_set sartris_player_collide_ret 1; sar_expand less_than $$__tmp_x 10; cond $'var:less_than_ret=0$' svar_set sartris_player_collide_ret 1; sar_expand less_than $$__tmp_y 20; cond $'var:less_than_ret=0$' svar_set sartris_player_collide_ret 1"

sar_function sartris_player_minocoord_foreach "svar_set __tmp_sartris_player $'$1$'; svar_set __tmp_minocoord_rot $'$2$'; or __tmp_minocoord_rot $sartris_player_rot; sar_expand sartris_minocoord_for __sartris_player_minocoord_foreach $sartris_player_piece $$__tmp_minocoord_rot"
sar_function __sartris_player_minocoord_foreach "svar_add __tmp_x $sartris_player_x; svar_add __tmp_y $sartris_player_y; sar_expand $__tmp_sartris_player $$__tmp_x $$__tmp_y"

sar_function sartris_next_minocoord_foreach "sartris_minocoord_for $'$1$' $sartris_next_piece 0"

sar_function sartris_minocoord_for "svar_set __sartris_minocoord_for $'$1$'; svar_set __sartris_minocoord_piece $2; svar_set __sartris_minocoord_rot $3; svar_set __sartris_minocoord_i 0; repeat $'__sartris_minocoord_for; svar_add __sartris_minocoord_i 1$' 4"
sar_function __sartris_minocoord_for "sar_expand $'svar_set __tmp_x $$__mino_$__sartris_minocoord_piece$-$__sartris_minocoord_rot$-$__sartris_minocoord_i$-_x; svar_set __tmp_y $$__mino_$__sartris_minocoord_piece$-$__sartris_minocoord_rot$-$__sartris_minocoord_i$-_y$'; sar_expand $$__sartris_minocoord_for $$__tmp_x $$__tmp_y"

svar_set sartris_hud_offset 1000
sar_expand exec $sartris_root/display

sar_function sartris_player_new "svar_set sartris_player_piece $'$sartris_next_piece$'; rand 7; sar_expand svar_set sartris_next_piece $$rand_ret; svar_set sartris_player_x 4; sar_expand svar_set sartris_player_y $'$$__mino_$sartris_next_piece$-top$'; svar_set sartris_player_rot 0; sartris_next_draw"
sartris_player_new; sartris_player_new
sartris_player_draw

sar_on_tick_clear
sar_on_tick "sartris_tick"
sar_function sartris_tick "svar_add sartris_gravity 1; svar_mod sartris_gravity 60; cond $'var:sartris_gravity=0$' sartris_player_gravity"
sar_on_tick "sartris_draw"

svar_set sartris_init 0
